<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Tent - Girton Feast</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="../images/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../images/favicons/favicon-16x16.png">
    <link rel="manifest" href="../images/favicons/site.webmanifest">
    <link rel="shortcut icon" href="../images/favicons/favicon.ico">

    <!-- Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts: Sigmar One and Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sigmar+One&family=Poppins:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/style.css">

    <style>
        /* Minimal custom overrides for specific dimensions not covered by Bootstrap */
        .map-container {
            height: 600px;
        }
        .brewery-logo-small {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }
    </style>
</head>

<body class="bg-light" x-data="beerTent" x-on:keydown.window="$store.app.handleKonami($event.key)">

    <!-- Navbar Placeholder -->
    <div id="navbar-placeholder"></div>

    <!-- Header -->
    <header class="bg-secondary text-white py-5 mb-5 text-center position-relative overflow-hidden shadow">
        <div class="container position-relative z-1">
            <img src="../images/titles/beer-tent-title.png" style="width: 30%; min-width: 250px;" alt="Beer Tent" class="img-fluid mb-3 filter-drop-shadow">
            <p class="lead mb-0 fs-4 fw-light">Proudly Supporting Local Breweries</p>
            <p class="mb-0 opacity-75">Also stocking a range of wines, lagers and prosecco.</p>
        </div>
    </header>

    <div class="container mb-5">

        <!-- View Toggle -->
        <div class="d-flex justify-content-center mb-5">
            <div class="btn-group" role="group" aria-label="View Toggle">
                <input type="radio" class="btn-check" name="btnradio" id="btn-breweries" autocomplete="off" value="breweries" x-model="view">
                <label class="btn btn-outline-primary px-4 py-2 fw-bold" for="btn-breweries">Breweries</label>

                <input type="radio" class="btn-check" name="btnradio" id="btn-beers" autocomplete="off" value="beers" x-model="view">
                <label class="btn btn-outline-primary px-4 py-2 fw-bold" for="btn-beers">Beers</label>
            </div>
        </div>

        <!-- BREWERY VIEW -->
        <div id="brewery-view" x-show="view === 'breweries'">
            <!-- Brewery Cards / Slider Section -->
            <div class="row mb-5">
                <div class="col-12">
                    <h2 class="mb-3 text-primary" style="font-family: 'Sigmar One', cursive;">
                        Our Breweries
                    </h2>
                    <div id="brewery-list" class="d-flex flex-nowrap overflow-auto pb-3 gap-3" style="scroll-behavior: smooth;">
                        <template x-for="brewery in sortedBreweries" :key="brewery.name">
                            <div class="brewery-card-container" style="min-width: 260px; max-width: 260px;">
                                <div class="card h-100 shadow-sm border-0 hover-scale" @click="activateBreweryFilter(brewery.name)" style="cursor: pointer;">
                                    <div class="card-body text-center d-flex flex-column align-items-center justify-content-center p-4">
                                        <div style="height: 80px; width: 100%; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                            <img :src="brewery.imagePath" :alt="brewery.name + ' Logo'" style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                        </div>
                                        <h5 class="card-title fw-bold text-truncate w-100" style="color: var(--brand-marian-blue); font-family: 'Sigmar One', cursive;" x-text="brewery.name"></h5>
                                        <p class="card-text small text-muted text-truncate w-100" x-text="brewery.description || 'Proud local brewery.'"></p>
                                        <a :href="brewery.website || '#'" target="_blank" class="btn btn-sm btn-outline-primary mt-3 website-btn" @click.stop>Visit Website</a>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <!-- Map Section -->
            <div class="row mb-5">
                <div class="col-12">
                    <div id="brewery-map" class="map-container rounded-4 shadow border border-5 border-white"></div>
                </div>
            </div>

        </div>

        <!-- BEER VIEW (Hidden by default) -->
        <div id="beer-view" x-show="view === 'beers'" x-cloak>
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2" id="beer-list-section">
                        <!-- Header can go here if needed, or rely on toggle context -->
                    </div>

                    <div class="beer-list-container bg-white p-4 rounded-4 shadow-sm">
                        <!-- Enhanced Filter Bar -->
                        <div class="filter-bar bg-white p-3 rounded-3 shadow-sm mb-4 border">
                            <div class="row g-3 align-items-end">
                                <!-- Search -->
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold text-muted mb-1">Search</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                        <input type="text" id="beer-search" class="form-control border-start-0" placeholder="Name, style..." x-model="filterSearch">
                                    </div>
                                </div>
                                <!-- Brewery Filter -->
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted mb-1">Brewery</label>
                                    <select class="form-select" id="filter-brewery" x-model="filterBrewery">
                                        <option value="">All Breweries</option>
                                        <template x-for="b in sortedBreweries" :key="b.name">
                                            <option :value="b.name" x-text="b.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <!-- Type/Style Filter -->
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold text-muted mb-1">Type</label>
                                    <select class="form-select" id="filter-type" x-model="filterType">
                                        <option value="">All Types</option>
                                        <template x-for="t in filterTypes" :key="t">
                                            <option :value="t" x-text="t"></option>
                                        </template>
                                    </select>
                                </div>
                                <!-- Sort -->
                                <div class="col-md-2">
                                    <label class="form-label small fw-bold text-muted mb-1">Sort By</label>
                                    <select class="form-select" id="sort-select" x-model="sortBy">
                                        <option value="name">Name (A-Z)</option>
                                        <option value="abv-asc">ABV (Low)</option>
                                        <option value="abv-desc">ABV (High)</option>
                                        <option value="brewery">Brewery</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="beer-list" class="row g-4">
                            <!-- Empty State -->
                            <div class="col-12 text-center text-muted py-5" x-show="filteredBeers.length === 0 && allBeers.length > 0" style="display: none;">
                                No beers found matching your criteria.
                            </div>
                            <!-- Loading State -->
                             <div class="col-12 text-center py-5" x-show="allBeers.length === 0">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>

                            <!-- Beer Items -->
                            <template x-for="beer in filteredBeers" :key="beer.name + beer.breweryName">
                                <div class="col-md-6 col-lg-4">
                                    <div class="beer-card bg-white h-100">
                                        <div class="d-flex align-items-start">
                                             <div style="flex-shrink: 0;" class="me-3">
                                                 <img :src="beer.breweryLogo" class="brewery-logo-small rounded-circle border p-1" :alt="beer.breweryName + ' logo'" style="width:50px; height:50px;">
                                             </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <h5 class="mb-0 fw-bold text-dark lh-sm" x-text="beer.name"></h5>
                                                    <span class="abv-badge ms-2" style="flex-shrink:0;" x-text="beer.abv.toFixed(1) + '%'"></span>
                                                </div>
                                                <div class="brewery-name small mb-2" x-text="beer.breweryName"></div>
                                                <span class="badge rounded-pill text-bg-light border border-secondary-subtle text-secondary fw-normal">
                                                    <i class="fas fa-beer me-1 opacity-50"></i> <span x-text="beer.style"></span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Mobile Nav Placeholder -->
    <div id="mobile-nav-placeholder"></div>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Main Script -->
    <script src="../js/script.js"></script>

    <!-- Alpine Component: Beer Tent -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('beerTent', () => ({
                allBeers: [],
                breweries: [],
                view: 'breweries', // 'breweries' or 'beers'
                filterBrewery: '',
                filterType: '',
                filterSearch: '',
                sortBy: 'name',
                map: null,

                get filterTypes() {
                    const types = new Set();
                    this.allBeers.forEach(b => { if(b.style) types.add(b.style); });
                    return Array.from(types).sort();
                },

                get sortedBreweries() {
                     return [...this.breweries].sort((a,b) => a.name.localeCompare(b.name));
                },

                get filteredBeers() {
                    let filtered = [...this.allBeers];

                    if (this.filterBrewery) {
                        filtered = filtered.filter(beer => beer.breweryName === this.filterBrewery);
                    }
                    if (this.filterType) {
                        filtered = filtered.filter(beer => beer.style === this.filterType);
                    }
                    if (this.filterSearch) {
                        const term = this.filterSearch.toLowerCase();
                        filtered = filtered.filter(beer =>
                            beer.name.toLowerCase().includes(term) ||
                            beer.breweryName.toLowerCase().includes(term) ||
                            beer.style.toLowerCase().includes(term)
                        );
                    }

                    if (this.sortBy === 'name') {
                        filtered.sort((a, b) => a.name.localeCompare(b.name));
                    } else if (this.sortBy === 'abv-asc') {
                        filtered.sort((a, b) => a.abv - b.abv);
                    } else if (this.sortBy === 'abv-desc') {
                        filtered.sort((a, b) => b.abv - a.abv);
                    } else if (this.sortBy === 'brewery') {
                        filtered.sort((a, b) => a.breweryName.localeCompare(b.breweryName));
                    }
                    return filtered;
                },

                init() {
                    fetch('../beer-tent.json')
                        .then(response => response.json())
                        .then(data => {
                            this.breweries = data;
                            this.allBeers = [];
                            this.breweries.forEach(brewery => {
                                brewery.imagePath = '../' + brewery.logo;
                                brewery.beers.forEach(beer => {
                                    this.allBeers.push({
                                        ...beer,
                                        breweryName: brewery.name,
                                        breweryId: brewery.id,
                                        breweryLogo: brewery.imagePath
                                    });
                                });
                            });
                            
                            this.$nextTick(() => {
                                this.initMap();
                            });
                        })
                        .catch(err => console.error('Failed to load beer data:', err));
                        
                    this.$watch('view', value => {
                        if (value === 'breweries' && this.map) {
                            setTimeout(() => { this.map.invalidateSize(); }, 100);
                        }
                    });

                    document.addEventListener('brewery-selected', (e) => {
                        this.activateBreweryFilter(e.detail);
                    });
                },

                setView(v) {
                    this.view = v;
                },

                activateBreweryFilter(name) {
                    this.filterBrewery = name;
                    this.view = 'beers';
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                initMap() {
                    const container = document.getElementById('brewery-map');
                    if (!container || this.map) return;

                    var girtonCoords = [52.240069, 0.084899];
                    this.map = L.map(container).setView(girtonCoords, 11);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(this.map);

                    var feastIcon = L.divIcon({
                        className: 'feast-marker',
                        html: '<i class="fas fa-flag fa-2x" style="color: #e91e63; text-shadow: 2px 2px 0 #fff;"></i>',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30],
                        popupAnchor: [0, -30]
                    });
                    var feastMarker = L.marker(girtonCoords, { icon: feastIcon, zIndexOffset: 1000 }).addTo(this.map);
                    feastMarker.bindPopup('<div class="text-center"><h6 class="fw-bold mb-0">Girton Feast</h6><p class="small mb-0">You are here!</p></div>');
                    
                    var markers = [feastMarker];
                    
                    this.breweries.forEach(brewery => {
                        let lat = brewery.coords[0];
                        let lng = brewery.coords[1];
                        var logoIcon = L.divIcon({
                            className: 'brewery-logo-marker',
                            html: `<div style="width: 50px; height: 100px; display: flex; flex-direction:column; align-items: center; justify-content: flex-start;">
                                    <div style="width: 50px; height: 50px; background:white; border-radius:50%; border: 2px solid #ccc; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                     <img src="${brewery.imagePath}" style="width: 100%; height: 100%; object-fit: contain;">
                                    </div>
                                    <div class="map-pin-arrow" style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid #ccc; margin-top:-2px;"></div>
                                   </div>`,
                            iconSize: [50, 70],
                            iconAnchor: [25, 65],
                            popupAnchor: [0, -65]
                        });
                        const marker = L.marker([lat, lng], { icon: logoIcon }).addTo(this.map);

                        const popupContent = `
                            <div class="text-center" style="cursor: pointer;">
                                <img src="${brewery.imagePath}" width="50" class="mb-2">
                                <h6 class="fw-bold mb-1">${brewery.name}</h6>
                                <p class="small mb-0 text-muted">${brewery.description || ''}</p>
                                <button class="btn btn-sm btn-primary mt-2 filter-map-btn" onclick="document.dispatchEvent(new CustomEvent('brewery-selected', { detail: '${brewery.name}' }))">Show Beers</button>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        marker.on('click', () => {
                             this.activateBreweryFilter(brewery.name);
                        });
                        
                        markers.push(marker);
                    });
                    
                    if (markers.length > 0) {
                         var group = new L.featureGroup(markers);
                         this.map.fitBounds(group.getBounds().pad(0.1));
                    }
                }
            }));
        });
    </script>

    <!-- Page Specific Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadComponent("#navbar-placeholder", "../components/navbar.html");
            loadComponent("#footer-placeholder", "../components/footer.html")
                .then(() => setCopyrightYear());

            // Initialize functionality
            // initBeerTent() removed - handled by Alpine

        });
    </script>
</body>

</html>