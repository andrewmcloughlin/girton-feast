<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Gallery - Girton Feast</title>

    <!-- Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Fonts: Sigmar One and Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sigmar+One&family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- 1. Add Fancybox CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="style.css">
    <!-- Favicon Placeholder (replace with your actual favicon) -->
    <link rel="icon" href="images/mascot.png" type="image/png">
</head>
<body class="bg-brand-light-yellow" data-bs-spy="scroll" data-bs-target="#gallery-nav" data-bs-smooth-scroll="true" tabindex="0">

    <!-- Placeholder for the navigation bar -->
    <div id="navbar-placeholder"></div>

    <main class="container my-5">
        <div class="text-center pt-5 mb-5">
            <h1 class="display-4" style="font-family: 'Sigmar One', cursive; color: var(--brand-marian-blue);">Relive the memories</h1>
            <p class="lead text-muted">A look back at previous years of the Girton Feast.</p>
        </div>

        <div class="row">
            <!-- Scrollspy Navigation Column -->
            <div class="col-lg-3 d-none d-lg-block">
                <nav id="gallery-nav" class="sticky-top p-3 rounded bg-brand-marian-blue">
                    <ul id="gallery-nav-ul" class="nav nav-pills flex-column">
                        <!-- Year links will be dynamically inserted here -->
                    </ul>
                </nav>
            </div>

            <!-- Gallery Content Column -->
            <div id="gallery-container-wrapper" class="col-lg-9">
                <!-- Mobile Dropdown Navigation -->
                <div class="d-lg-none mb-4 sticky-top" style="top: 80px; z-index: 100;">
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle w-100" type="button" id="galleryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Select a Year
                        </button>
                        <ul id="gallery-dropdown-ul" class="dropdown-menu w-100" aria-labelledby="galleryDropdown">
                            <!-- Mobile year links will be inserted here -->
                        </ul>
                    </div>
                </div>
                <div id="gallery-container"></div>
            </div>
        </div>
    </main>

    <!-- Footer Placeholder -->
    <div id="footer-placeholder"></div>

    <!-- Bootstrap JS Bundle from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JSZip library for creating zip files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 2. Add Fancybox JS -->
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <script src="script.js"></script> <!-- Link to the new external script file -->
    <script>
        // --- START: Gallery Configuration ---
        // To add photos, simply update this configuration.
        // The script will automatically find images named 1.jpg, 2.jpg, etc.
        // inside the folder for each year.
        const photoConfig = [
            { year: 2025, imageCount: 52 },
            { year: 2018, imageCount: 36 },
            { year: 2017, imageCount: 40 },
            { year: 2016, imageCount: 45 },
            { year: 2015, imageCount: 15 },
            { year: 2014, imageCount: 14 },
            { year: 2013, imageCount: 41 },
            { year: 2012, imageCount: 50 },
            // Example: { year: 2021, imageCount: 8 },
        ];
        // --- END: Gallery Configuration ---

        // Function to build the gallery from the configuration
        function buildGallery() {
            const galleryContainer = document.getElementById('gallery-container');
            const galleryNavUl = document.getElementById('gallery-nav-ul');
            const galleryDropdownUl = document.getElementById('gallery-dropdown-ul');
            if (!galleryContainer || !galleryNavUl || !galleryDropdownUl) return;

            // Sort years in descending order
            photoConfig.sort((a, b) => b.year - a.year);

            let allYearsHtml = '';
            let navLinksHtml = '';

            let dropdownLinksHtml = '';
            photoConfig.forEach(config => {
                const yearId = `year-${config.year}`;

                // Create the nav link for the scrollspy
                navLinksHtml += `
                    <li class="nav-item">
                        <a class="nav-link" href="#${yearId}">${config.year}</a>
                    </li>
                `;

                // Create the dropdown link
                dropdownLinksHtml += `
                    <li><a class="dropdown-item" href="#${yearId}">${config.year}</a></li>
                `;

                // Create the gallery section for the year
                allYearsHtml += `
                    <div id="${yearId}" class="year-gallery-group mb-5">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="display-5" style="font-family: 'Sigmar One', cursive; color: var(--brand-marian-blue);">${config.year}</h2>
                            <button class="btn download-btn" onclick="downloadYearAsZip(${config.year}, this)">
                                <i class="fas fa-download"></i><span class="d-none d-sm-inline ms-2">Download All</span>
                            </button>
                        </div>
                        <div class="row g-4">
                `;

                for (let i = 1; i <= config.imageCount; i++) {
                    const imagePath = `images/previous/${config.year}/${i}.jpg`;
                    const delay = (i - 1) * 50; // 50ms delay for each image
                    allYearsHtml += `
                        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                            <a href="${imagePath}" 
                               data-fancybox="gallery-${config.year}" 
                               data-caption="Girton Feast ${config.year} - Photo ${i}" 
                               class="gallery-img-container"
                               style="animation-delay: ${delay}ms;">
                                <img src="${imagePath}" class="gallery-img" alt="Girton Feast ${config.year} - Photo ${i}" loading="lazy" onload="this.classList.add('loaded')">
                            </a>
                        </div>
                    `;
                }

                allYearsHtml += `</div></div>`; // Close .row and .year-gallery-group
            });

            // 2. Set the innerHTML of the container only once with the complete HTML string
            galleryContainer.innerHTML = allYearsHtml;
            galleryNavUl.innerHTML = navLinksHtml;
            galleryDropdownUl.innerHTML = dropdownLinksHtml;

            // 3. Initialize Fancybox on the newly added elements
            Fancybox.bind("[data-fancybox]", {});
        }

        // --- Download All Function ---
        async function downloadYearAsZip(year, button) {
            const config = photoConfig.find(c => c.year === year);
            if (!config) return;

            // Provide user feedback
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Zipping...';

            const zip = new JSZip();
            const imagePromises = [];

            for (let i = 1; i <= config.imageCount; i++) {
                const imageUrl = `images/previous/${year}/${i}.jpg`;
                const promise = fetch(imageUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`Image ${i}.jpg not found`);
                        return response.blob();
                    })
                    .then(blob => {
                        zip.file(`${i}.jpg`, blob);
                    })
                    .catch(error => console.error(`Failed to fetch ${imageUrl}:`, error));
                imagePromises.push(promise);
            }

            await Promise.all(imagePromises);

            zip.generateAsync({ type: "blob" })
                .then(function(content) {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `girton-feast-${year}-photos.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Restore button state
                    button.disabled = false;
                    button.innerHTML = originalText;
                });
        }

        // Load the navbar and then build the gallery
        document.addEventListener('DOMContentLoaded', () => {
            loadComponent('#navbar-placeholder', 'navbar.html');
            // The initializeCountdown function is now in script.js, but only called from index.html
            loadComponent('#footer-placeholder', 'footer.html').then(() => setCopyrightYear());
            buildGallery();
        });
    </script>
</body>
</html>
